---
layout: post
title:  "[논문 리뷰]실시간 이상 감지 모델 Robust Random Cut Forest (RRCF)"
date:   2021-7-14 20:00
categories: [PaperReview]
use_math: true
comments: true
---

# <center>Robust Random Cut Forest (RRCF)</center>
**<center>실시간 스트리밍 데이터에도 적합한 이상 감지 모델이 있다?</center>**<br/><br/>

오늘의 논문 먹방은 바로 "[Robust Random Cut Forest Based Anomaly Detection On Streams](https://proceedings.mlr.press/v48/guha16)" 으로 2016년 ICML에 게재된 논문입니다. 이 논문에서 제안하는 Robust random cut forest (RRCF) 모델은 트리 기반 이상 감지 모델입니다. RRCF는 가장 대표적인 트리 기반 이상 감지 모델인 [Isolation Forest](https://ieeexplore.ieee.org/document/4781136)와 차이가 거의 없습니다. 하지만 그 작은 차이가 엄청난 기여를 만들어냈습니다. <br/><br/>

![Figure1](https://raw.githubusercontent.com/HiddenBeginner/hiddenbeginner.github.io/master/static/img/_posts/2021-07-14-rrcf/rrcf-figure1.png){: width="400" height="400"){: .center}
<center>[토이 데이터에 IF (위)와 RRCF (아래)를 적용한 결과. 파란색 선은 탑승객 수, 빨간색은 각 모델의 이상 스코어를 나타낸다.]</center><br/><br/>

위 그림은 제 마음대로 선정한 이 논문의 메인 figure 입니다. 파란색 선은 사인 그래프에서 235~255 구간을 이상 신호로 변환한 것입니다. 빨간색 선이 데이터의 이상 정도를 나타내는 이상 스코어입니다. 이 값이 높으면 데이터를 이상 데이터로 간주하게 됩니다. IF (위 그래프)의 경우 이상 신호가 모두 끝난 후에야 이상 스코어 값이 높아집니다. 반면에 RRCF (아래 그래프)의 경우 이상 신호의 시작점과 종료점에서 모두 이상 스코어가 높습니다. 실제 세계 문제에서는 대부분 실시간 이상 감지를 요구하는 것을 고려하면 RRCF의 이상 스코어가 더욱 합리적이라고 생각됩니다.<br><br>

**들어가기 전에**
- 이 논문이 2016년 논문이라는 것을 유념하고 읽어주시길 바랍니다. 최신 동향과는 맞지 않을 수 있습니다.
- Isolation Forest를 알고 있으면 포스팅 이해에 도움이 될 것입니다. 이와 관련하여 [고려대학교 강필성 교수님의 강의 영상](https://youtu.be/puVdwi5PjVA)을 추천드립니다.

<br>

**이 포스트에서 다룰 내용들**
- <a href="#section1">기존 이상 감지 모델들의 한계점</a>
- <a href="#section2">RRCF 알고리즘</a>
- <a href="#section3">실험</a>

---


<span id="section1"></span>
## 기존 이상감지 모델들의 한계점

2008년 이전까지의 이상 감지 모델들은 밀도 (density) 기반 또는 거리 (distance) 기반이었습니다. 
- 밀도 기반 모델들은 데이터들의 확률밀도함수를 모델링하여, 특정 데이터가 등장할 확률이 낮으면 해당 데이터를 이상 데이터로 간주합니다.
- 거리 기반 모델들은 데이터 사이의 거리를 모두 계산하여, 다른 데이터들에 비해 멀리 동 떨어진 데이터를 이상 데이터로 간주하는 방법입니다.

<br>

두 방법론들 모두 각각의 장단점이 있겠지만, 데이터의 양과 차원 수가 높을 경우 계산 복잡도도 굉장히 높고 성능은 오히려 떨어지는 단점이 있었습니다. 직관적으로 생각했을 때,
- 데이터의 양이 증가할수록 이상 데이터도 증가할 것입니다. 만약 이상 데이터가 모여 작은 군집을 이룬다면 위 두 방법론들이 잘 적용되지 않을 것입니다. 
- 데이터의 차원이 증가할수록 확률밀도함수를 추정하기 어려울 것입니다.

<br>

2008년 기존의 방법론들과 전혀 다른 트리 기반 이상 감지 모델인 Isolation Forest (IF)가 등장하게 됩니다. IF는 정말 간단한 아이디어로 이상 감지 문제에서 굉장한 성능 향상을 가져왔습니다. IF는 "정말 이게 머신러닝 모델이 맞아?"라는 생각이 들 정도로 어처구니 없는 알고리즘입니다. 알고리즘을 간략히 요약하면 다음과 같습니다. **Coming soon !**



---

<span id="section2"></span>
## RRCF 알고리즘

위에서 언급한 한계점들을 해결하기 위해 본 논문에서는 Robust random cut forest (RRCF)를 제안합니다. RRCF는 IF와 크게 두 부분만 다릅니다.
- Feature $p$를 선택할 때 uniform random하게 뽑는 대신, 각 feature가 갖는 값의 범위에 따라 확률을 다르게 부여하여 선택합니다.
- Average path length 대신, Collusive displacement (CoDisp)라는 새로운 이상 스코어를 사용합니다.

1번 변경사항은 실시간 스트리밍 환경에서도 이상 감지 모델이 잘 동작할 수 있게 만들어줍니다. 2번 변경사항은 이상 데이터를 다른 관점으로 정의함으로서 이상 감지 성능을 향상시켰습니다.<br><br>

### Robust random cut tree (RRCT)
`RRCF`의 각 트리는 다음과 같이 만들어집니다. 주어진 (서브샘플링 된) 데이터셋 $S$에 대하여 robust random cut tree (RRCT) $\mathcal{T}(S)$는 다음과 같이 만들어집니다. (`RRCT 생성 알고리즘`)
- 랜덤하게 feature $p$를 선택합니다. 이때, $i$번 째 feature가 선택될 확률은 $\frac{l_i}{\sum_j l_j}$ 입니다. 여기서 $l_i=\max_{x \in S}x_i-\min_{x \in S} x_i$ 입니다.
- $[\min_{x \in S} x_i, \max_{x \in S}x_i]$ 범위에서 uniform random하게 값 $q$를 선택합니다.
- Left child를 $S_1=\\{x \mid x \in S, x_i \le q\\}$ 로, right child로 $S_2=\\{x \mid x \in S, x_i > q\\}$로 분기합니다.
- 위를 반복합니다.

이렇게 만든 트리들을 모아놓은 것을 `RRCF`라고 부릅니다.<br><br>

`IF`와 비교하였을 때 다른 점은 feature $p$를 균등하게 선택하는 것이 아닌 각 feature가 갖는 값의 범위에 따라 서로 다른 확률을 부여하여 선택한다는 것입니다. 이 작은 차이만으로 시간에 따라 분포가 점점 달라지는 데이터에 대응하여 트리를 만들 수 있게 됩니다. 따라서 논문에서는 `RRCF`가 실시간 스트리밍 데이터에 적합한 알고리즘이라고 주장하고 있습니다. 잠시 이 주제를 짚고 넘어가도록 하겠습니다.

### 실시간 스트리밍 환경
실시간 스트리밍 환경에서는 시간의 흐름에 따라 유입되는 데이터의 분포가 달라질 수 있습니다. 과거 데이터를 학습한 모델이 앞으로 유입되는 데이터에 대해서도 좋은 성능을 보일 것이라는 보장은 없습니다. 따라서 새롭게 유입되는 데이터들을 계속 모델 학습에 사용해야 합니다. 예를 들어, 현재 시점이 $t$일 때, 가장 최근 256개의 데이터로 트리를 구성한다고 생각해보겠습니다.
- $S_t=\\{\mathbf{x}\_{t-255}, \mathbf{x}\_{t-254},\cdots, \mathbf{x}\_t\\}$
- $\mathcal{T}(S_t)$ : $S_t$로 만든 RRCT

다음 시점으로 넘어가면 $S\_{t+1}=\\{\mathbf{x}\_{t-254},\cdots,\mathbf{x}\_{t},\mathbf{x}\_{t+1}\\}$ 을 이용하여 RRCT를 다시 만들어야 합니다. 이때, `RRCT 생성 알고리즘`을 통해 $\mathcal{T}(S_{t+1})$ 을 만들 수도 있겠지만, 이미 만들어놓은 $\mathcal{T}(S_t)$를 사용해서 만들 수 있다면 더욱 효율적일 것입니다. RRCT는 결국 각 leaf 노드가 (이론상) 데이터 한 개인 트리이기 때문에 $\mathcal{T}(S_t)$에서 $\mathbf{x}\_{t-255}$를 삭제하고, $\mathbf{x}\_{t+1}$ 추가하여 $\mathcal{T}'(S\_{t+1})$을 만들 수 있습니다.<br/><br/>

이때, $\mathcal{T}(S_{t+1})$은 `RRCT 생성 알고리즘`으로 만든 것이고, $\mathcal{T}'(S_{t+1})$은 $\mathcal{T}(S_t)$을 변형해서 만든 것을 유념하셔야 합니다.
- `RRCT 생성 알고리즘`는 feature $p$와 값 $q$의 선택에 따라 무수히 많은 $\mathcal{T}(S_{t+1})$을 만들 수 있습니다. 
    - 즉, $\mathcal{T}(S_{t+1})$을 random variable으로 간주하고 확률분포를 생각해볼 수 있습니다.
    
- $\mathcal{T}'(S\_{t+1})$은 $\mathcal{T}(S\_t)$에서 $\mathbf{x}\_{t-255}$를 삭제하고, $\mathbf{x}\_{t+1}$ 추가하여 유일하게 결정됩니다. 즉, $\mathcal{T}'(S\_{t+1})$은 $\mathcal{T}(S\_t)$에 종속적입니다.
    - 마찬가지로, $\mathcal{T}(S\_t)$을 random variable으로 간주하고 $\mathcal{T}'(S\_{t+1})$의 확률분포를 생각해볼 수 있습니다.
<br><br>

여기서 주목해야할 것은 $\mathcal{T}(S_{t+1})$의 확률분포와 $\mathcal{T}'(S_{t+1})$의 확률분포가 같을 것이라고 기대하기는 힘듭니다. 단순히 생각해봐도 
- $\mathcal{T}(S_{t+1})$은 $S_{t+1}$의 feature 값들의 최소/최대값을 사용하여 만들어지고,
- $\mathcal{T}'(S_{t+1})$은 $S_{t}$의 feature 값들의 최소/최대값을 사용하여 만들어진 트리에 노드 삭제/추가 연산만 더해진 것

뿐이기 때문입니다. 그리고 두 확률분포가 다르다는 이야기는 다음과 같습니다.
- 실시간 스트리밍 환경에서 새로 유입된 데이터를 학습한 모델 $\mathcal{T}(S_{t+1})$의 분포와 다른 분포를 갖는 모델 $\mathcal{T}'(S_{t+1})$을 사용한다는 것입니다.
- 따라서 엉뚱한 트리들로 데이터들의 이상 스코어를 계산할 확률이 증가한다는 것입니다. 

하지만 놀랍게도 `RRCT 생성 알고리즘`으로 생성된 트리에 논문에서 제안하는 노드 삭제/추가 알고리즘을 사용하면  $\mathcal{T}(S_{t+1})$와  $\mathcal{T}'(S_{t+1})$의 분포가 같아진다고 합니다. 보다 더 정확한 이론의 statement와 증명은 논문을 참고하시면 좋을 것 같습니다. 왜냐하면 너무 어려워서 저는 읽기를 포기했기 때문입니다.

### Collusive displacement (CoDisp)
Coming soon !!
